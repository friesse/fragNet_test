name: Build GC Server

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ${{ matrix.os }}

    env:
      # Disable SCCache due to GitHub Actions cache service issues
      SCCACHE_GHA_ENABLED: "false"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        clean: true  # Force clean checkout
    
    # NUCLEAR OPTION: Clear all GitHub Actions caches
    - name: Clear All Caches
      run: |
        echo "Clearing all possible cache locations..."
        rm -rf ~/.cache/* || true
        rm -rf ~/work/_temp/* || true
        rm -rf ${{ github.workspace }}/.cmake || true
        rm -rf ${{ github.workspace }}/build || true
        rm -rf ${{ github.workspace }}/_deps || true
        
    # Touch all source files to force recompilation
    - name: Force Source File Timestamps
      run: |
        echo "Updating all source file timestamps to force recompilation..."
        find ${{ github.workspace }} -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "*.c" \) -exec touch {} + || true
        echo "Build timestamp: $(date)" > ${{ github.workspace }}/FORCE_REBUILD.txt

    # Linux Dependencies
    - if: matrix.os == 'ubuntu-latest'
      name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libmariadb-dev \
          libmariadb-dev-compat \
          libcrypto++-dev \
          pkg-config \
          git

    # Temporarily disabled SCCache due to GitHub Actions cache service issues
    # - if: matrix.os != 'windows-latest'
    #   name: Setup sccache (Linux/Mac)
    #   uses: mozilla-actions/sccache-action@v0.0.6

    # Linux Build
    - if: matrix.os == 'ubuntu-latest'
      name: Configure CMake (Linux)
      run: |
        # AGGRESSIVE: Clear CMake cache and force reconfigure
        rm -rf ${{ github.workspace }}/build
        rm -rf ${{ github.workspace }}/CMakeCache.txt
        rm -rf ${{ github.workspace }}/CMakeFiles
        mkdir -p ${{ github.workspace }}/build
        mkdir -p ${{ github.workspace }}/release
        cd ${{ github.workspace }}/build
        # Add timestamp to force reconfiguration
        echo "Build started at: $(date)" > BUILD_INFO.txt
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                 -DCMAKE_C_COMPILER_LAUNCHER="" \
                 -DCMAKE_CXX_COMPILER_LAUNCHER="" \
                 -DCRYPTOPP_BUILD_TESTING=OFF \
                 -DCRYPTOPP_INSTALL=OFF \
                 -Dprotobuf_BUILD_TESTS=OFF \
                 -Dprotobuf_WITH_ZLIB=OFF
    
    - if: matrix.os == 'ubuntu-latest'
      name: Build (Linux)
      run: |
        cd ${{ github.workspace }}/build
        # Build with verbose output
        cmake --build . --config ${{ matrix.build_type }} -j$(nproc) --verbose
        
        # Check if build was successful and show the build directory structure
        echo "Build completed. Directory structure:"
        find . -type f -executable -print -o -name "*.so*" -print | sort
        
    - if: matrix.os == 'ubuntu-latest'
      name: Find and Package Binary
      run: |
        # Create release directory
        mkdir -p ${{ github.workspace }}/release/gc_server
        
        BIN="$(find "${{ github.workspace }}/build" -maxdepth 4 -type f \( -name 'gc-server*' -o -name 'gc_server*' \) | head -n1)"
        if [ -z "$BIN" ]; then
            echo "Error: Could not find built binary. Build may have failed."
            echo "Build directory contents:"
            find "${{ github.workspace }}/build" -type f -print | sort
            exit 1
        fi
        echo "Found binary at: $BIN"
        cp "$BIN" "${{ github.workspace }}/release/gc_server/"
        
        # Copy Steam API library (64-bit for Linux)
        STEAM_LIB="${{ github.workspace }}/steamworks/sdk/redistributable_bin/linux64/libsteam_api.so"
        if [ -f "$STEAM_LIB" ]; then
            echo "Copying Steam API library..."
            cp -v "$STEAM_LIB" "${{ github.workspace }}/release/gc_server/"
        else
            echo "WARNING: Steam API library not found at $STEAM_LIB"
        fi
        
        # Copy additional files
        cp -v "${{ github.workspace }}/README.md" "${{ github.workspace }}/release/" || echo "README.md not found, skipping"
        cp -v "${{ github.workspace }}/QUICK_START.md" "${{ github.workspace }}/release/" || echo "QUICK_START.md not found, skipping"
        
        # Copy items directory if it exists
        if [ -d "${{ github.workspace }}/items" ]; then
            cp -r "${{ github.workspace }}/items" "${{ github.workspace }}/release/"
        fi
        
        # Make start script executable if it exists
        if [ -f "${{ github.workspace }}/start_gc_server.sh" ]; then
            cp -v "${{ github.workspace }}/start_gc_server.sh" "${{ github.workspace }}/release/"
            chmod +x "${{ github.workspace }}/release/start_gc_server.sh"
        fi
        
        chmod +x "${{ github.workspace }}/release/gc_server"/* || true

    # Windows Build
    - if: matrix.os == 'windows-latest'
      name: Build Windows
      shell: bash
      run: |
        # AGGRESSIVE: Clear ALL build artifacts
        rm -rf ${{ github.workspace }}/build
        rm -rf ${{ github.workspace }}/CMakeCache.txt
        rm -rf ${{ github.workspace }}/CMakeFiles
        rm -rf ${{ github.workspace }}/*.vcxproj
        rm -rf ${{ github.workspace }}/*.sln
        mkdir ${{ github.workspace }}/build
        mkdir ${{ github.workspace }}/release
        cd ${{ github.workspace }}/build
        echo "Build started at: $(date)" > BUILD_INFO.txt
        cmake .. -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        # Force rebuild ALL targets
        cmake --build . --config ${{ matrix.build_type }} --parallel --clean-first

    - if: matrix.os == 'windows-latest'
      name: Package Windows
      shell: bash
      run: |
        mkdir -p ${{ github.workspace }}/release/gc_server
        BIN="$(find "${{ github.workspace }}/build" -type f \( -name 'gc-server*.exe' -o -name 'gc_server*.exe' \) 2>/dev/null | head -n1)"
        [ -n "$BIN" ] && cp "$BIN" ${{ github.workspace }}/release/gc_server/ || true
        cp ${{ github.workspace }}/README.md ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/QUICK_START.md ${{ github.workspace }}/release/ || true
        cp -r ${{ github.workspace }}/items ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/start_gc_server.bat ${{ github.workspace }}/release/ || true

    # Upload Artifacts
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gc-server-${{ matrix.os }}-${{ matrix.build_type }}
        path: ${{ github.workspace }}/release
        retention-days: 30

    # Create Release on Tag
    - if: startsWith(github.ref, 'refs/tags/')
      name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ github.workspace }}/release/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
